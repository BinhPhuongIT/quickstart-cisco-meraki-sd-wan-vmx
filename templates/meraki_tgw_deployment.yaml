AWSTemplateFormatVersion: 2010-09-09
Description: >-
   This template deploys a transit gateway in a VPC and creates a TGW attachment to the avalaible subnets in the VPC. (qs-1s3afc2th)
Parameters:

  VPCID:
    Description: 'ID of the VPC (e.g., vpc-0343606e)'
    Type: 'AWS::EC2::VPC::Id'

  AvailabilityZone1SubnetID:
    Description: Subnet ID to be used for the deployment of vMX-1 in Availability Zone 1
    Type: 'AWS::EC2::Subnet::Id'

  AvailabilityZone2SubnetID:
    Description: Subnet ID to be used for the deployment of vMX-2 in Availability Zone 2
    Type: 'AWS::EC2::Subnet::Id'

  AmazonSideASN:
    Description: ASN to be used for the Amazon TGW
    Type: String

Resources:
  TransitGateway:
    Type: "AWS::EC2::TransitGateway"
    Properties:
      AmazonSideAsn: !Ref 'AmazonSideASN'
      Description: "Transit Gateway for vMX deployment"
      AutoAcceptSharedAttachments: "disable"
      DefaultRouteTableAssociation: "disable"
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - vmx-tgw  

  TransitGatewayAttachment:
    Type: "AWS::EC2::TransitGatewayAttachment"
    DependsOn:
    - TransitGateway
    Properties:
      VpcId: !Ref VPCID
      TransitGatewayId: !Ref TransitGateway
      SubnetIds:
      - !Ref AvailabilityZone1SubnetID
      - !Ref AvailabilityZone2SubnetID
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - vmx-vpc-attach

  TransitGatewaySDWANRouteTable:
    Type: "AWS::EC2::TransitGatewayRouteTable"
    Properties:
      Tags: 
      - Key: Name
        Value: !Sub ${AWS::StackName}-SDWANrtb
      TransitGatewayId: !Ref TransitGateway
  
  SdwanRouteTablePropogation:
    Type: "AWS::EC2::TransitGatewayRouteTablePropagation"
    Properties:
      TransitGatewayAttachmentId: !Ref TransitGatewayAttachment
      TransitGatewayRouteTableId: !Ref TransitGatewaySDWANRouteTable


Outputs:
  TransitGatewayID:
    Value: !Ref 'TransitGateway'
